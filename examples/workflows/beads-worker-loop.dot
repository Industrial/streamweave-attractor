digraph BeadsWorkerLoop {
  graph [
    goal="Drain ready beads tasks one by one; do not commit .beads/issues.jsonl",
    label="Beads worker loop (claim → implement → commit → close → repeat)"
  ]
  rankdir=LR

  start [shape=Mdiamond, label="Start"]
  exit [shape=Msquare, label="Exit"]

  check_ready [
    shape=box,
    label="Check ready",
    type=exec,
    command="devenv shell -- sh -c 'bd ready --json | jq -ce \"if length == 0 then halt_error(1) else {context_updates: {ready_task_id: .[0].id}} end\" > \"${ATTRACTOR_STAGE_DIR:-.attractor}/outcome.json\"'"
  ]

  status_in_progress [shape=box, label="Claim task", prompt="Claim the task whose id is in context key ready_task_id. Run: devenv shell -- bd update $ready_task_id --status in_progress --claim --json. Exit 0."]

  implement [shape=box, label="Implement", prompt="You are the beads-worker (see .cursor/agents/beads-worker.md). Implement the claimed task. Follow project rules: Effect.ts, devenv shell, no todo_write. Run tests/linters for changed code. Do not run bd close or git commit yet. Exit 0 when done."]

  git_commit [shape=box, label="Git commit", prompt="Commit code and config changes with a conventional commit message. Do NOT stage or commit .beads/issues.jsonl; exclude it from the commit. Use: devenv shell -- git add (files other than .beads/issues.jsonl), then git commit -m \"<message>\". Exit 0."]

  status_done [shape=box, label="Close task", prompt="Close the task: run devenv shell -- bd close $ready_task_id --reason \"Done\" --json. Exit 0. The pipeline will then return to Check ready."]

  start -> check_ready
  check_ready -> status_in_progress [label="has_tasks", condition="outcome=success"]
  check_ready -> exit [label="no_tasks", condition="outcome=fail"]
  status_in_progress -> implement [label="success", condition="outcome=success"]
  status_in_progress -> exit [label="failure", condition="outcome=fail"]
  implement -> git_commit [label="success", condition="outcome=success"]
  implement -> exit [label="failure", condition="outcome=fail"]
  git_commit -> status_done [label="success", condition="outcome=success"]
  git_commit -> exit [label="failure", condition="outcome=fail"]
  status_done -> check_ready [label="success", condition="outcome=success"]
  status_done -> exit [label="failure", condition="outcome=fail"]
}
