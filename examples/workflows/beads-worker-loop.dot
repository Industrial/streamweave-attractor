digraph BeadsWorkerLoop {
  graph [
    goal="Drain ready beads tasks one by one; do not commit .beads/issues.jsonl",
    label="Beads worker loop (claim → implement → commit → close → repeat)"
  ]
  rankdir=LR

  start [shape=Mdiamond, label="Start"]
  exit [shape=Msquare, label="Exit"]

  check_ready [
    shape=box,
    label="Check ready",
    prompt="Run: devenv shell -- bd ready --json. Parse the output. If there is at least one ready task, write a JSON file to $ATTRACTOR_STAGE_DIR/outcome.json with: {\"context_updates\": {\"has_tasks\": \"true\", \"ready_task_id\": \"<id>\"}} where <id> is the first task's id (e.g. monorepo-123 or bd-123). If there are no ready tasks, write outcome.json with: {\"context_updates\": {\"has_tasks\": \"false\"}}. Then exit 0."
  ]

  status_in_progress [shape=box, label="Claim task", prompt="Claim the task whose id is in context key ready_task_id. Run: devenv shell -- bd update $ready_task_id --status in_progress --claim --json. Exit 0."]

  implement [shape=box, label="Implement", prompt="You are the beads-worker (see .cursor/agents/beads-worker.md). Implement the claimed task. Follow project rules: Effect.ts, devenv shell, no todo_write. Run tests/linters for changed code. Do not run bd close or git commit yet. Exit 0 when done."]

  git_commit [shape=box, label="Git commit", prompt="Commit code and config changes with a conventional commit message. Do NOT stage or commit .beads/issues.jsonl; exclude it from the commit. Use: devenv shell -- git add (files other than .beads/issues.jsonl), then git commit -m \"<message>\". Exit 0."]

  status_done [shape=box, label="Close task", prompt="Close the task: run devenv shell -- bd close $ready_task_id --reason \"Done\" --json. Exit 0. The pipeline will then return to Check ready."]

  start -> check_ready
  check_ready -> status_in_progress [label="has_tasks", condition="has_tasks=true"]
  check_ready -> exit [label="no_tasks", condition="has_tasks=false"]
  check_ready -> exit [label="default"]
  status_in_progress -> implement
  implement -> git_commit
  git_commit -> status_done
  status_done -> check_ready
}
